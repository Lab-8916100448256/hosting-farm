<!-- Generated by SpecStory -->

# Improving Unauthenticated Access Handling (2025-03-25 18:57:53)

_**User**_

When trying to access the authenticated home page without being logged-in, we end up on an error page with json content. It would be better silently redirecting to the unauthenticated home page. Keeping the error in the log when the auth token is not found would be nice though. As it could help future debugging of other issues.

---

_**Assistant**_

I'll help you modify the code to handle unauthenticated access more gracefully by redirecting to the unauthenticated home page while maintaining error logging. Let me first search for the relevant code.


---

<details>
            <summary>Searched codebase "handle authentication error redirect home page" â€¢ **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/views/auth/login.html.tera` | L34-67 |
| `src/controllers/auth_pages.rs` | L126-179 |
| `src/views/home/index.html.tera` | L1-26 |
| `assets/views/auth/verify.html.tera` | L33-59 |
| `src/controllers/home_pages.rs` | L1-38 |
| `src/views/js/auth.js` | L29-38 |
| `src/controllers/auth_pages.rs` | L179-233 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L10716-10787 |
| `src/controllers/auth_pages.rs` | L44-98 |
| `assets/views/auth/login.html.tera` | L1-41 |
| `src/controllers/auth_pages.rs` | L98-126 |
| `src/views/js/auth.js` | L43-49 |
| `src/controllers/auth_pages.rs` | L233-244 |
| `src/views/auth/login.html.tera` | L1-34 |
| `src/views/js/auth.js` | L38-43 |
| `src/views/js/auth.js` | L1-7 |
| `src/views/js/auth.js` | L49-59 |
| `assets/views/auth/verify.html.tera` | L1-33 |
| `src/controllers/auth_pages.rs` | L1-44 |
| `src/views/base.html.tera` | L1-46 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L6344-6401 |
| `src/views/js/auth.js` | L7-12 |
| `assets/views/home/index.html.tera` | L1-39 |
| `src/views/js/auth.js` | L12-17 |
| `src/controllers/auth.rs` | L171-220 |

</details>

---

Let me analyze the code and make the necessary changes to handle unauthenticated access more gracefully. I'll need to modify the authentication handling in both the frontend and backend.

First, let's modify the frontend JavaScript to handle authentication errors better:


---

```diff
  // Make logout available globally
  window.logout = logout;
+ 
+ // Handle authentication errors
+ export function handleAuthError(error) {
+     console.error('Authentication error:', error);
+     window.location.href = '/auth/login';
+ }
  
  // Intercept fetch requests to add auth header
  const originalFetch = window.fetch;
  window.fetch = function(url, options = {}) {
      options.headers = addAuthHeader(options.headers);
-     return originalFetch(url, options);
+     return originalFetch(url, options)
+         .then(response => {
+             if (response.status === 401) {
+                 handleAuthError('Unauthorized');
+             }
+             return response;
+         })
+         .catch(error => {
+             if (error.message.includes('401')) {
+                 handleAuthError(error);
+             }
+             throw error;
+         });
  }; 
```

---

Now, let's modify the backend to handle authentication errors more gracefully. We'll need to modify the home page controller to redirect unauthenticated users to the login page:


---

```diff
  use tera;
  use crate::utils::template::render_template;
+ use axum::response::Redirect;
  
  /// Renders the home page for non-authenticated users
      let mut context = tera::Context::new();
      
-     if let Ok(user) = users::Model::find_by_pid(&ctx.db, &auth.claims.pid).await {
-         context.insert("user", &user);
-         context.insert("active_page", "home");
-         context.insert("invitation_count", &0); // TODO: Get actual invitation count
-     }
-     
-     render_template(&ctx, "home/index.html.tera", context)
+     match users::Model::find_by_pid(&ctx.db, &auth.claims.pid).await {
+         Ok(user) => {
+             context.insert("user", &user);
+             context.insert("active_page", "home");
+             context.insert("invitation_count", &0); // TODO: Get actual invitation count
+             render_template(&ctx, "home/index.html.tera", context)
+         }
+         Err(err) => {
+             tracing::error!(
+                 error = err.to_string(),
+                 user_pid = auth.claims.pid,
+                 "user not found during authentication"
+             );
+             Ok(Redirect::to("/auth/login").into_response())
+         }
+     }
  }
  
```

---

Now let's modify the home page template to handle the authentication state better:



---

```diff
  <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <div class="px-4 py-6 sm:px-0">
+         {% if user %}
          <div class="border-4 border-dashed border-gray-200 rounded-lg h-96 p-4">
              <h1 class="text-2xl font-bold text-gray-900">Welcome, {{ user.name }}!</h1>
              </ul>
          </div>
+         {% else %}
+         <div class="border-4 border-dashed border-gray-200 rounded-lg h-96 p-4">
+             <h1 class="text-2xl font-bold text-gray-900">Welcome to Hosting Farm!</h1>
+             <p class="mt-4 text-gray-600">Please log in to access your account.</p>
+             <div class="mt-6">
+                 <a href="/auth/login" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
+                     Log in
+                 </a>
+             </div>
+         </div>
+         {% endif %}
      </div>
  </div>
      import { isAuthenticated } from '/js/auth.js';
      
-     if (!isAuthenticated()) {
-         window.location.href = '/login';
+     // Only redirect if we're on the authenticated home page and not authenticated
+     if (window.location.pathname === '/home' && !isAuthenticated()) {
+         window.location.href = '/auth/login';
      }
  </script>
```

---

These changes accomplish the following:

1. In the frontend JavaScript:
   - Added a `handleAuthError` function to handle authentication errors gracefully
   - Modified the fetch interceptor to catch 401 errors and redirect to the login page
   - Added error logging for debugging purposes

2. In the backend:
   - Modified the `authenticated_index` function to handle authentication errors gracefully
   - Added error logging when a user is not found during authentication
   - Added a redirect to the login page when authentication fails

3. In the home page template:
   - Added conditional rendering based on authentication state
   - Added a welcome message and login button for unauthenticated users
   - Modified the JavaScript to only redirect when on the authenticated home page
   - Fixed the login page URL to use the correct path

Now when a user tries to access the authenticated home page without being logged in:
1. The backend will log the error for debugging purposes
2. The user will be silently redirected to the login page
3. The unauthenticated home page will show a welcome message with a login button
4. The frontend will handle any authentication errors gracefully

Let me know if you'd like me to make any adjustments to these changes!

---



---

