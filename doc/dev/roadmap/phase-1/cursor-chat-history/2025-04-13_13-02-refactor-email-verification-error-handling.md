<!-- Generated by SpecStory -->

# Refactor Email Verification Error Handling (2025-04-13 15:02:04)

_**User**_

refactor this part to render the "auth/verify.html" view with an error message stating that the email verification failed, similarly to what is done in the other error case below, instead of propagating the error to the caller with the question mark operator. 

---

_**Assistant**_



---

Okay, I can help with that. I will modify the `verify_email` function to handle the error from `active_model.verified` and render the `auth/verify.html` view with an appropriate error message instead of propagating the error.



---

```diff
              } else {
                  let active_model = user.into_active_model();
-                 let _user = active_model.verified(&ctx.db).await?;
-                 tracing::info!(pid = _user.pid.to_string(), "user verified");
-                 format::render().view(
-                     &v,
-                     "auth/verify.html",
-                     data!({
-                         "success": true,
-                         "message": "Your email is now verified.",
-                     }),
-                 )
+                 match active_model.verified(&ctx.db).await {
+                     Ok(_user) => {
+                         tracing::info!(pid = _user.pid.to_string(), "user verified");
+                         format::render().view(
+                             &v,
+                             "auth/verify.html",
+                             data!({
+                                 "success": true,
+                                 "message": "Your email is now verified.",
+                             }),
+                         )
+                     }
+                     Err(e) => {
+                         tracing::error!(pid = user.pid.to_string(), error = ?e, "failed to mark user as verified");
+                         format::render().view(
+                             &v,
+                             "auth/verify.html",
+                             data!({
+                                 "success": false,
+                                 "message": "Email verification failed. Please try again or contact support.",
+                             }),
+                         )
+                     }
+                 }
              }
          }
```

---



---

I have modified the `verify_email` function in `src/controllers/auth_pages.rs` to handle the error as requested. Instead of propagating the error, it now catches it and renders the verification page with an appropriate error message.

---



---

