<!-- Generated by SpecStory -->

# Team Invitation Error Handling with HTMX (2025-03-26 20:55:55)

_**User**_

When the user is trying to invite another user to a team bu that other user is already a member of that team or has already been invited, an error message should be displayed on the page, using HTMX of course

---

_**Assistant**_



---

I'll modify the `invite_member_handler` function to check if the user is already a member or has a pending invitation before creating a new invitation.

---

```diff
      }
      
-     // Create invitation
-     let invitation = _entities::team_memberships::Model::create_invitation(&ctx.db, team.id, &params.email).await?;
-     
-     // Find the invited user
-     let invited_user = users::Model::find_by_id(&ctx.db, invitation.user_id).await?;
-     
-     // Send invitation email using the TeamMailer
-     crate::mailers::team::TeamMailer::send_invitation(&ctx, &invited_user, &team, &invitation).await?;
+     // Find the user by email
+     let target_user = match users::Model::find_by_email(&ctx.db, &params.email).await {
+         Ok(user) => user,
+         Err(_) => {
+             // If user doesn't exist, proceed with invitation as normal
+             // Create invitation
+             let invitation = _entities::team_memberships::Model::create_invitation(&ctx.db, team.id, &params.email).await?;
+             
+             // Find the invited user
+             let invited_user = users::Model::find_by_id(&ctx.db, invitation.user_id).await?;
+             
+             // Send invitation email using the TeamMailer
+             crate::mailers::team::TeamMailer::send_invitation(&ctx, &invited_user, &team, &invitation).await?;
+             
+             // Redirect back to the team page
+             let redirect_url = format!("/teams/{}", team_pid);
+             tracing::info!("Redirecting to: {}", redirect_url);
+             let response = Response::builder()
+                 .header("HX-Redirect", redirect_url)
+                 .body(axum::body::Body::empty())?;
+ 
+             return Ok(response);
+         }
+     };
+     
+     // Check if user is already a member or has a pending invitation
+     let existing_membership = _entities::team_memberships::Entity::find()
+         .filter(_entities::team_memberships::Column::TeamId.eq(team.id))
+         .filter(_entities::team_memberships::Column::UserId.eq(target_user.id))
+         .one(&ctx.db)
+         .await?;
+     
+     if let Some(membership) = existing_membership {
+         // User already has a relationship with this team
+         let error_message = if membership.pending {
+             format!("User {} already has a pending invitation to this team", params.email)
+         } else {
+             format!("User {} is already a member of this team", params.email)
+         };
+         
+         // Return error message with HTMX
+         let html_response = format!(
+             "<div id='invitation-error' class='mt-2 text-sm text-red-600'>{}</div>",
+             error_message
+         );
+         
+         let response = Response::builder()
+             .header("Content-Type", "text/html")
+             .header("HX-Retarget", "#invitation-error-container")
+             .header("HX-Swap", "innerHTML")
+             .body(axum::body::Body::from(html_response))?;
+             
+         return Ok(response);
+     }
+     
+     // If we get here, the user exists but isn't a member, so create invitation
+     let invitation = _entities::team_memberships::Model::create_invitation(&ctx.db, team.id, &params.email).await?;
+     
+     // Send invitation email using the TeamMailer
+     crate::mailers::team::TeamMailer::send_invitation(&ctx, &target_user, &team, &invitation).await?;
      
      // Redirect back to the team page
```

---

Now let's also update the invite form template to include the error container that we target with our HTMX response.

---

<details>
            <summary>Searched codebase "invite.html.tera" â€¢ **1** results</summary>
        
| File |
|------|
| `undefined` |

</details>

---

Read file: assets/views/teams/invite.html.tera

---

Now I'll update the invite form template to include the error container:

---

```diff
                              <input type="email" name="email" id="email" class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md">
                              <p class="mt-2 text-sm text-gray-500">The user must have an account on Hosting Farm to receive the invitation.</p>
+                             <div id="invitation-error-container"></div>
                          </div>
                      </div>
```

---

Now let's also update the form to use HTMX properly to handle the response:

---

```diff
      </div>
      <div class="mt-5 md:mt-0 md:col-span-2">
-         <form action="/teams/{{ team.pid }}/invite" method="POST" hx-post="/teams/{{ team.pid }}/invite" hx-swap="outerHTML">
+         <form action="/teams/{{ team.pid }}/invite" method="POST" hx-post="/teams/{{ team.pid }}/invite">
              <div class="shadow overflow-hidden sm:rounded-md">
                  <div class="px-4 py-5 bg-white sm:p-6">
```

---

Great! Now the implementation is complete. Here's what we've done:

1. Updated the `invite_member_handler` function to:
   - Check if the user is already a member or has a pending invitation
   - Return an error message using HTMX when a user is already invited or a member
   - Continue normal invitation process when the user can be invited

2. Modified the invite form template to:
   - Add an error container with ID `invitation-error-container`
   - Remove the default `hx-swap` attribute to allow both error messages and redirects to work properly

Now when a team admin tries to invite someone who's already a member or has a pending invitation, they'll see an error message on the form instead of being redirected, all handled with HTMX.

---



---

