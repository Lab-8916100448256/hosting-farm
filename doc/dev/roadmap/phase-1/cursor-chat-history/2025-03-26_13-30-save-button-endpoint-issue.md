<!-- Generated by SpecStory -->

# Save Button Endpoint Issue (2025-03-26 14:30:42)

_**User**_

On the team edit view, the save button is not calling the correct endpoint. it is calling an API endpoint instead of a human-facing endpoint.

---

_**Assistant**_



---

Let me check the team edit view and fix the endpoint issue.

---

<details>
            <summary>Searched codebase "team edit" • **10** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Let me examine the team edit view template:

---

Read file: /home/douzeb/gits/nixin/hosting-farm/assets/views/teams/edit.html.tera

---

Now I need to find out the controller files for teams to see what endpoints are available:

---

<details>
            <summary>Searched codebase "teams controller" • **10** results</summary>
        
| File |
|------|
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |
| `undefined` |

</details>

---

Let me examine both the API controller and the pages controller for teams:

---

Read file: /home/douzeb/gits/nixin/hosting-farm/src/controllers/teams_pages.rs

---

Read file: /home/douzeb/gits/nixin/hosting-farm/src/controllers/teams_pages.rs

---

Now let me check the API controller:

---

Read file: /home/douzeb/gits/nixin/hosting-farm/src/controllers/teams.rs

---

Read file: /home/douzeb/gits/nixin/hosting-farm/src/controllers/teams.rs

---

I've identified the issue. Let me fix it:

---

```diff
      </div>
      <div class="mt-5 md:mt-0 md:col-span-2">
-         <form action="/api/teams/{{ team.pid }}" method="POST" hx-put="/api/teams/{{ team.pid }}" hx-swap="outerHTML">
+         <form action="/teams/{{ team.pid }}/update" method="POST" hx-post="/teams/{{ team.pid }}/update" hx-swap="outerHTML">
              <div class="shadow sm:rounded-md sm:overflow-hidden">
                  <div class="px-4 py-5 bg-white space-y-6 sm:p-6">
```

---

Now I need to add the update route to the teams_pages controller:

---

```diff
      format::redirect(&redirect_url)
  }
+ 
+ /// Handle team edit form submission
+ #[debug_handler]
+ async fn update_team_handler(
+     auth: JWT,
+     State(ctx): State<AppContext>,
+     Path(team_pid): Path<String>,
+     Form(params): Form<crate::models::teams::UpdateTeamParams>,
+ ) -> Result<Response> {
+     let user = users::Model::find_by_pid(&ctx.db, &auth.claims.pid).await?;
+     
+     tracing::info!("Updating team with pid: {}", team_pid);
+     
+     // Find team
+     let team = match _entities::teams::Model::find_by_pid(&ctx.db, &team_pid).await {
+         Ok(team) => team,
+         Err(e) => {
+             tracing::error!("Failed to find team with pid {}: {:?}", team_pid, e);
+             return Err(Error::string("Team not found"));
+         }
+     };
+     
+     // Check if user is an owner of this team
+     let membership = _entities::team_memberships::Entity::find()
+         .filter(_entities::team_memberships::Column::TeamId.eq(team.id))
+         .filter(_entities::team_memberships::Column::UserId.eq(user.id))
+         .filter(_entities::team_memberships::Column::Pending.eq(false))
+         .one(&ctx.db)
+         .await?;
+     
+     if let Some(membership) = membership {
+         if membership.role != "Owner" {
+             return unauthorized("Only team owners can edit team details");
+         }
+     } else {
+         return unauthorized("You are not a member of this team");
+     }
+     
+     // Update the team
+     let updated_team = team.update(&ctx.db, &params).await?;
+     
+     // Redirect to the team details page
+     format::redirect(&format!("/teams/{}", updated_team.pid))
+ }
  
  /// Team routes
          .add("/{team_pid}", get(team_details))
          .add("/{team_pid}/edit", get(edit_team_page))
+         .add("/{team_pid}/update", post(update_team_handler))
          .add("/{team_pid}/invite", get(invite_member_page))
  } 
```

---

I've successfully fixed the issue:

1. Changed the form in the team edit view to use a human-facing endpoint (`/teams/{team_pid}/update`) instead of the API endpoint (`/api/teams/{team_pid}`).

2. Changed the HTTP method from `PUT` to `POST` for the form submission, as human-facing endpoints typically use form submissions with POST.

3. Added a new route handler `update_team_handler` in the `teams_pages.rs` controller that:
   - Receives the form data
   - Verifies the user has permission to edit the team
   - Updates the team in the database
   - Redirects back to the team details page

These changes align with the rules for human-facing endpoints:
- Not prefixed with `/api/`
- Defined in the `_pages.rs` controller file
- Uses form submissions for data input
- Redirects to an appropriate page after successful action

The team edit form should now correctly use the human-facing endpoint instead of the API endpoint.

---



---

