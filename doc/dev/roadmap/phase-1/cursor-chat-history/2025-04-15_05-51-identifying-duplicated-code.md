<!-- Generated by SpecStory -->

# Identifying Duplicated Code (2025-04-15 07:51:32)

_**User**_

identify duplicated code in this file

---

_**Assistant**_



---




---



---

Okay, I've analyzed the code in `src/controllers/teams_pages.rs` and found several areas with duplicated logic:

1.  **Authentication Check:** Almost every handler function starts with the same block to check if the user is authenticated via `JWTWithUserOpt` and redirects to `/auth/login` if not. This pattern is repeated extensively.
    ```rust
    let user = if let Some(user) = auth.user {
        user
    } else {
        return redirect("/auth/login", headers);
    };
    ```

2.  **Fetching Pending Invitation Count:** The logic to query the database for the count of pending invitations for the current user is duplicated in `create_team_page`, `list_teams`, `team_details`, `invite_member_page`, and `edit_team_page`.
    ```rust
    // Get pending invitations count
    let invitations_result = team_memberships::Entity::find()
        .find_with_related(teams::Entity)
        .all(&ctx.db)
        .await;

    let invitations = match invitations_result {
        Ok(data) => data
            .into_iter()
            .filter(|(membership, _)| membership.user_id == user.id && membership.pending)
            .count(),
        Err(e) => {
            // ... error handling ...
        }
    };
    ```

3.  **Finding Team by PID:** Many handlers need to find a `teams::Model` using its `pid`. The pattern of calling `teams::Model::find_by_pid` and handling the `Result` (often returning `error_page` or `error_fragment` on failure) is repeated in functions like `team_details`, `invite_member_page`, `edit_team_page`, `update_team_handler`, `cancel_invitation`, `update_member_role`, `remove_member`, `delete_team`, and `invite_member_handler`.

4.  **Permission Checks (Admin/Owner):** Several handlers check if the current user has an "Administrator" or "Owner" role within a specific team. This involves fetching the user's `team_memberships` record for that team and checking the `role` field. While the exact role being checked might vary, the pattern of querying and checking is similar across `team_details`, `invite_member_page`, `edit_team_page`, `update_team_handler`, `cancel_invitation`, `update_member_role`, `remove_member`. The `has_role` method on `teams::Model` is used in a few places (`delete_team`, `invite_member_handler`), which is a good step towards reducing this duplication, but it's not used consistently.

5.  **Finding Invitation by Token:** The logic to find a `team_memberships` record by its `invitation_token` is duplicated in `accept_invitation`, `decline_invitation`, and `cancel_invitation`.

6.  **Finding User by PID:** The pattern to find a `users::Model` by `pid` and handle errors appears in `update_member_role` and `remove_member`.

7.  **Fetching Specific Membership:** Querying the `team_memberships` table to get the record for a specific `user_id` and `team_id` is a common operation, often done as part of permission checks (see point 4) but also standalone in places like `team_details`.

These duplicated blocks could potentially be refactored into helper functions or middleware to improve maintainability and reduce redundancy.

---



---

