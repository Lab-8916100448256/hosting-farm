<!-- Generated by SpecStory -->

# Implementing Logout Route on Homepage (2025-03-25 18:36:11)

_**User**_

implement the route for the logout menu on the home page.

---

_**Assistant**_

I'll help you implement the logout route. First, let me search for relevant code to understand the current implementation.


---

<details>
            <summary>Searched codebase "logout route or handler implementation" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/controllers/auth.rs` | L220-241 |
| `src/views/js/auth.js` | L43-49 |
| `src/controllers/auth.rs` | L171-220 |
| `src/views/js/auth.js` | L49-59 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-23_21-25-sign-out-menu-not-functioning.md` | L132-193 |
| `src/controllers/auth_pages.rs` | L126-179 |
| `src/controllers/auth_pages.rs` | L179-233 |
| `src/controllers/auth.rs` | L74-132 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-23_21-25-sign-out-menu-not-functioning.md` | L79-132 |
| `src/controllers/auth.rs` | L132-171 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-23_21-25-sign-out-menu-not-functioning.md` | L788-840 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L10716-10787 |
| `src/views/base.html.tera` | L1-46 |
| `src/views/js/auth.js` | L12-17 |
| `src/controllers/auth_pages.rs` | L98-126 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-23_21-25-sign-out-menu-not-functioning.md` | L1-79 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-23_21-25-sign-out-menu-not-functioning.md` | L727-788 |
| `src/views/js/auth.js` | L29-38 |
| `src/controllers/auth.rs` | L1-74 |
| `src/controllers/home_pages.rs` | L1-38 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_15-24-sign-out-menu-not-responding.md` | L78-120 |
| `src/controllers/auth_pages.rs` | L1-44 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_15-24-sign-out-menu-not-responding.md` | L1-78 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-24_20-00-summary-of-@requirements-md.md` | L4335-4375 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L6401-6457 |

</details>

---

Let me check the layout template to see how the sign out form is implemented.


---

Read file: assets/views/layout.html.tera

---

I see the issue now. The logout link is currently implemented as a regular anchor tag instead of an HTMX form. Let me modify the layout template to use HTMX for the logout functionality.


---

```diff
                          <div class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50" role="menu" id="user-menu">
                              <a href="/users/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Your Profile</a>
-                             <a href="/auth/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Logout</a>
+                             <form hx-post="/api/auth/logout" hx-swap="outerHTML" hx-push-url="true">
+                                 <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Logout</button>
+                             </form>
                              <a href="/test/dummy" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="test">Dummy</a>
                          </div>
```

---

I've made the following changes to fix the logout functionality:

1. Replaced the anchor tag with an HTMX form that makes a POST request to `/api/auth/logout`
2. Added `hx-swap="outerHTML"` to ensure the entire page is replaced with the response
3. Added `hx-push-url="true"` to update the browser's history when the logout is successful
4. Used a button inside the form to maintain the same styling and behavior

The logout functionality should now work correctly. When you click the "Logout" button:
1. The form will make a POST request to `/api/auth/logout`
2. The server will clear the auth token cookie and send a redirect response
3. HTMX will handle the redirect and take you to the login page

Please try clicking the logout button again. It should now properly log you out and redirect you to the login page.

---

_**User**_

do not use an API endpoint as a target of the logout menu. remember the cursor rules?

---

_**Assistant**_

Ah yes, you're right. According to the cursor rules, we should use server-side routes for handling authentication actions rather than API endpoints. Let me modify the logout form to use the server-side route instead.


---

```diff
                          <div class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50" role="menu" id="user-menu">
                              <a href="/users/profile" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Your Profile</a>
-                             <form hx-post="/api/auth/logout" hx-swap="outerHTML" hx-push-url="true">
+                             <form hx-post="/auth/logout" hx-swap="outerHTML" hx-push-url="true">
                                  <button type="submit" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">Logout</button>
                              </form>
```

---

Now I need to add the server-side logout route handler. Let me search for the auth pages controller to add the logout handler.


---

<details>
            <summary>Searched codebase "auth pages controller routes implementation" • **25** results</summary>
        
| File | Lines |
|------|-------|
| `src/controllers/auth_pages.rs` | L179-233 |
| `src/controllers/mod.rs` | L1-6 |
| `src/controllers/home_pages.rs` | L1-38 |
| `src/controllers/auth_pages.rs` | L1-44 |
| `src/controllers/auth_pages.rs` | L126-179 |
| `src/controllers/auth.rs` | L220-241 |
| `src/controllers/auth_pages.rs` | L98-126 |
| `src/controllers/auth.rs` | L74-132 |
| `src/controllers/auth_pages.rs` | L44-98 |
| `src/controllers/teams_pages.rs` | L230-241 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L1562-1929 |
| `src/controllers/auth.rs` | L171-220 |
| `src/controllers/auth.rs` | L132-171 |
| `src/controllers/auth.rs` | L1-74 |
| `src/controllers/users.rs` | L53-94 |
| `src/views/js/auth.js` | L43-49 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L2006-2074 |
| `src/controllers/teams_pages.rs` | L170-230 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L6401-6457 |
| `src/utils/middleware.rs` | L1-28 |
| `src/views/auth/login.html.tera` | L1-34 |
| `src/controllers/users.rs` | L1-53 |
| `doc/dev/roadmap/phase-1/cursor-chat-history/2025-03-25_07-26-requirements-verification-and-implementation.md` | L2074-2149 |
| `src/views/js/auth.js` | L38-43 |
| `src/controllers/teams_pages.rs` | L110-170 |

</details>

---

Let me add the server-side logout handler to the auth_pages controller.


---

```diff
      render_template(&ctx, "auth/verify.html.tera", context)
  }
+ 
+ /// Handles user logout by clearing the auth token cookie
+ #[debug_handler]
+ async fn handle_logout() -> Result<Response> {
+     let response = Response::builder()
+         .header("Set-Cookie", "auth_token=; Path=/; Expires=Thu, 01 Jan 1970 00:00:00 GMT")
+         .header("HX-Redirect", "/auth/login")
+         .body(axum::body::Body::empty())?;
+     Ok(response)
+ }
  
  /// Authentication page routes
          .add("/reset-password", get(reset_password))
          .add("/verify/{token}", get(verify_email))
+         .add("/logout", post(handle_logout))
  } 
```

---

I've made the following changes:

1. Added a server-side logout handler `handle_logout` that:
   - Clears the auth token cookie by setting its expiration date to the past
   - Sets the `HX-Redirect` header to redirect to the login page after logout
   - Returns an empty response body

2. Added the logout route to the auth pages routes:
   - Added `/auth/logout` as a POST endpoint
   - Connected it to the `handle_logout` handler

The logout functionality should now work correctly. When you click the "Logout" button:
1. The form will make a POST request to `/auth/logout`
2. The server will clear the auth token cookie and send a redirect response
3. HTMX will handle the redirect and take you to the login page

Please try clicking the logout button again. It should now properly log you out and redirect you to the login page.

---



---

